<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head>



  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="keywords" content="EPICS, EPICSv4"><!-- Include the epicsv4 base.css, and the css for epics v4 documents -->
  
  <link rel="stylesheet" type="text/css" href="http://epics-pvdata.sourceforge.net/base.css">
  <link rel="stylesheet" type="text/css" href="http://epics-pvdata.sourceforge.net/epicsv4.css"><title>MASAR User Manual</title>
  
  <style type="text/css">
/*<![CDATA[*/


/*]]>*/</style></head><body>

<div class="head">
<h1>MASAR USER MANUAL<br>
</h1>
<!-- Maturity: Working Draft or Request for Comments, or Recommendation, and date. -->
 display how many points in saved data
<h2 class="nocount">MASAR User Manual, Editors Draft, 26-Mar-2012</h2>
<dl>
  <dt>This version:</dt>
    <dd><a href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/masarService/raw-file/tip/documentation/userManual.html">userManual_20120326.html</a></dd>
  <dt>Latest version:</dt>
    <dd><a href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/masarService/raw-file/tip/documentation/userManual.html">userManual.html</a></dd>
  <dt>Editors:</dt>
    <dd>Guobao Shen, BNL<br>
      Marty Kraimer, BNL<span style="font-weight: bold;"></span></dd>
</dl>
<dl>
</dl>
<hr>
</div>
<!-- Header material -->
<h2 class="nocount" id="contents">Table of Contents</h2>
<div class="toc">
<ul>
  <li><a href="#abstract">Abstract</a></li>
  <li><a href="#status">Status of this Document</a></li>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#note">NOTE</a></li>
  <li><a href="#requirement">System Requirement</a></li>
  <li><a href="#terminology">Terminology</a></li>
  <li><a href="#architecture">System Architecture</a></li>
  <li><a href="#server">MASAR Server</a></li>
  <ul>
    <li><a href="#functions">Functions</a></li>
    <li><a href="#dataformat">Data Format</a></li>
  </ul>
  <li><a href="#database">Relational Database</a></li>
  <ul>
    <li><a href="#sqlite3">SQLite3 Schema</a></li>
    <li><a href="#irmis">IRMIS Schema</a></li>
    <li><a href="#createdb">Create Database</a></li>
    <li><a href="#configdb">Database configuration</a></li>
  </ul>
  <li><a href="#installation">Install from source</a></li>
  <ul>
    <li><a href="#prepareinstall">Preparation</a></li>
    <li><a href="#pvdatainstall">Install pvDataCPP</a></li>
    <li><a href="#pvaccessinstall">Install pvAccessCPP</a></li>
    <li><a href="#pviocinstall">Install pvIOCCPP</a></li>
    <li><a href="#ntinstall">Install normativeTypes</a></li>
    <li><a href="#masarinstall">Install masarService</a></li>
  </ul>
  <li><a href="#runserver">Run MASAR Server</a></li>
  <ul>
    <li><a href="#pythonc">Python/C module</a></li>
    <li><a href="#pythonpath">PYTHONPATH</a></li>
    <li><a href="#masardb">MASAR SQLite database</a></li>
    <li><a href="#launchserver">Launch MASAR service</a></li>
    <li><a href="#launchserver2">Launch MASAR with other name</a></li>
    <li><a href="#stopserver">Stop MASAR service</a></li>
  </ul>
  <li><a href="#masarclient">MASAR Client</a></li>
  <ul>
    <li><a href="#pythonapi">Python API</a></li>
    <li><a href="#clientgui">Default GUI</a></li>
  </ul>
</ul>
</div>

<h2 class="nocount" id="abstract">Abstract</h2>

<p>MASAR (MAchine Snapshot, Archiving, and Retrieve) is an EPICS V4 service.
The server and client are implemented in C++ and Python. The server takes
machine snapshots, archives data in a relational database, and retrieves data
from the database. The client provides a GUI that retrieves data, compares data
with the live machine, and restores the machine with given snapshot data. The
client also provides support for other python and C++ code.</p>

<p>The server takes machine snapshot by using pre-defined configurations. To
take a snapshot the client specifies the name of the snapshot configuration and
a name for this snapshot event.When the server receives a command to take a
machine snapshot, the server retrieves, from the database, the list of V3
channel names for the configuration. It then gets the current value of all the
channels from V3 IOC, and saves the data as a snapshot event into the database.
</p>

<h2 class="nocount" id="status">Status of this Document</h2>

<p>This is the 26-Mar-2012 version of the MASAR User Manual. </p>

<h2 id="introduction">Introduction</h2>

<p>MASAR is implemented in C++ and Python. Network communication is implemented
via the EPICS V4 channelRPC mechanism . The current implementation uses SQLite3
for the relational database. A Python module PYMASAR provides access to
SQLite3. </p>

<p>Since EPICS V4 channelRPC server is implemented in C++, the interface
between the masar server and PYMASAR is implemented using Python/C. A Python
API is provided for the client user, and a default PyQt4 GUI is developed for
end user.</p>

<p>The products are all part of the <a href="http://epics-pvdata.sourceforge.net">V4</a> implementation of <a href="http://www.aps.anl.gov/epics">Experimental Physics and Industrial Control
System</a>, which are available via an <a href="http://epics-pvdata.sourceforge.net/LICENSE.html">open source
license</a>. </p>

<p>For now the only way to obtain the MASAR service is from the sourceforge
mercurial repository. Binary packages are available for Debian 7.0 (Wheezy).
</p>

<h2 id="note">NOTE
</h2>
<b>
<ol>
  <li>In the database, time is stored as UTC/POSIX time started from Jan, 1st, 1970. 
    There is a constant time shift in second since the seconds past EPOCH used by
    EPICS V3 starts from Jan 1st, 1990.
  </li>
  <li> Since all time stored in the RDB is in the UTC time format, the client
    Python API returns all raw data, which means time is in UTC format. This 
    impacts the API user.
  </li>
  <li> For the human being reading convenience, the default PyQt4 GUI displays
    it in local time.
  </li>
  <li>All timestamps in service_event, service_config, and pv_group tables are
    the time when inserting data into database. This means that the time stamp
    for a particular snapshot is the time when the data is inserted into
    database.</li>
  <li>Since the enum is converted to a string, it captures its label (display
    value) instead of its real value(0, 1, ...). Advantage doing that is if
    there is any changes on enum label, it probably means some V3 IOC database
    logic has changed. It is better to throw a message to show that explicitly.
  </li>
  <li> The compare and restore functions are provided only in PyQt4 GUI. Client
    user needs to use Python Client API to compare any sets of snapshot data, and
    manipulate the data.
  </li>
  <li> For restore function, instead of slowly and synchronously ramping 
    the value to given setting point, the MASAR GUI sets the value whatever
    it is to the IOC directly. It might be dangerous if IOC or other gateway does 
    not protect it. The restore function sets only the stored value back to IOC.
  </li>
  <li> The restore function does not verify a pv is a read-back or set-point.
  </li>
</ol>
</b>
<h2 id="requirement">System Requirement</h2>

<p>To run MASAR on you machine, Python and various EPICS V3 and V4 run-time
library are required for both client and server. </p>

<p>Python: </p>
<ul>
  <li>Python 2.7 or above</li>
</ul>

<p>EPICS modules: </p>
<ul>
  <li>EPICS V3 base R3.14.11 or above. Current release is R3.14.2, which can be
    downloaded from <a href="http://www.aps.anl.gov/epics/base/R3-14/12.php">here</a>.<br>
  </li>
  <li><a href="http://epics-pvdata.sourceforge.net/">EPICS V4</a> (managed by
    mercurial on source forge)<br>

    <ul>
      <li><a href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/pvDataCPP/raw-file/tip/documentation/pvDataCPP.html">pvDataCPP</a>
      </li>
      <li><a href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/pvAccessCPP/raw-file/tip/documentation/pvAccessCPP.html">pvAccessCPP</a>
      </li>
      <li><a href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/pvIOCCPP/raw-file/tip/documentation/pvIOCCPP.html">pIOCCPP</a></li>
      <li><a href="http://epics-pvdata.sourceforge.net/alpha/normativeTypes/normativeTypes.html">normativeTypes</a><br>
        The normative types implementation is under alpha version, which is
        under alphaCPP module.</li>
      <li><a href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/masarService/raw-file/tip/documentation/userManual.html">masarService</a>
      </li>
    </ul>
  </li>
</ul>

<p>For MASAR server, you need:</p>
<ul>
  <li>SQLite3 3.7 or above</li>
</ul>

<p>For MASAR client default GUI:</p>
<ul>
  <li>PyQt4 4.8 or above</li>
</ul>

<p>Currently, MASAR has been installed on the following systems:</p>
<ul>
  <li>Ubuntu 11.04 (Natty Narwhal)<br>
  </li>
  <li>Debian 7.0 (Wheezy)</li>
  <li>Fedora 14</li>
  <li>Fedora 16</li>
  <li>Mac OS-X 10.6.8 (Snow Leopard)<br>
  </li>
</ul>

<p></p>

<h2 id="terminology">Terminology</h2>
in addition to the terminology used by EPICS, MASAR defines the following: 
<ul>
  <li>pv group: A unique group.It has a name, list of V3 channel names,
    description, and date when group was created.</li>
  <li>service config: A unique configuration. It has a name, pv group name,
    description, and syatem to which system it belongs. </li>
  <li>system: Identifies the sub system to which each configuration
  belongs.</li>
  <li>service event: Description of a snapshot. It has comment, author name,
    date, and status;</li>
  <li>snapshot: The data for a snapshot event.</li>
  <li>interface name convention 
    <ul>
      <li>putXXXX(): put into a live machine, more specifically, an EPICS live
        pv</li>
      <li>getXXXX(): get from a live machine, more specifically, an EPICS live
        pv</li>
      <li>saveXXX(): save into a RDB</li>
      <li>retrieveXXX(): retrieve from a RDB</li>
    </ul>
  </li>
</ul>

<h2 id="architecture">System Architecture</h2>
The MASAR consists of client and server : 

<table>
  <tbody>
    <tr>
      <td><img src="masar/masar.png" height="360" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Architecture</td>
    </tr>
  </tbody>
</table>

<p>The client has a client Python API library, which can be used by both Python
scripting, and the GUI. A default PyQt4 GUI is developed for data viewing,
snapshot taking, comparing a snapshot with live machine, and restoring machine
to a particular status using a snapshot. </p>

<p>The server has 4 layers: </p>
<ul>
  <li>Service communication control: the pvAccess channel RPC instance.</li>
  <li>Service: parses a command from the client, implements desired action, and
    returns the result to the client.</li>
  <li>Channel Access Client: For now the only usage to to get the current value
    of a set of V3 channels.</li>
  <li>DSL (data source layer): This is the interface between C++ and Python.
    <ul>
      <li>PYMASAR: A Python module to access SQLite3 database, which is
        supported by default currently;</li>
      <li>PYIRMIS: A Python module to access IRMIS/MySQL database, which will
        be supported in the future.</li>
    </ul>
  </li>
  <li>Data layer. 
    <ul>
      <li>IOC: live machine data;</li>
      <li>IRMIS: static data, which can have all machine configuration.</li>
      <li>MASAR: embedded inside PYMASAR, which is dedicated to MASAR
      service.</li>
    </ul>
  </li>
</ul>

<h2 id="server">MASAR Server</h2>
The MASAR server can take a snapshot for any combination of EPICS channels,
including scalar channels of type string, enum, byte (8-bit), short (16-bit),
int (32-bit), long (which is same with integer in EPICS V3), float, and double,
and/or waveform/array pv with any above types except enum. Since the data types
supported by both Python and SQLite3/IRMIS are string, int, and real, the types
are casted as below: 

<table>
  <tbody>
    <tr>
      <td style="text-align: center;">epics data type</td>
      <td style="text-align: center;">data type carried by MASAR</td>
    </tr>
    <tr>
      <td style="text-align: center;">enum, string</td>
      <td style="text-align: center;">string</td>
    </tr>
    <tr>
      <td style="text-align: center;">byte, short, int/long</td>
      <td style="text-align: center;">long</td>
    </tr>
    <tr>
      <td style="text-align: center;">float, double</td>
      <td style="text-align: center;">double</td>
    </tr>
  </tbody>
</table>
The waveform data is casted following above rule, and stored as a BLOB in
database after being serialized into binary. At current stage, the BLOB is one
field of masar_data table, and might be separated as a standalone table if
there is any performance issue. 

<h3 id="functions">Functions </h3>

<p></p>

<p>The MASAR server side supports 6 fundamental functions to talk with RDB: </p>
<ol>
  <li><b>retrieveServiceConfigProps</b>: current MASAR database schema defines an 
  associated property table, service_config_prop, to host some user defined properties.
  One typical use is which sub-system one particular configuration belongs to. This function
  is to get a full list of sub-system that are defined for MASAR service in database.
  </li>
  <li><b>retrieveServiceConfigs</b>: get a list of the snapshot configurations
    with filter based on snapshot names.</li>
  <li><b>retrieveServiceEvents</b>: get a list how many snapshot events have
    been taken with filters based on snapshot names, author, and time range.</li>
  <li><b>retrieveSnapshot</b>: get real snapshot data;</li>
  <li><b>saveSnapshot</b>: save a snapshot into database;</li>
  <li><b>updateSnapshotEvent</b>: update a particular snapshot, for example
    flag a snapshot as approved;</li>
</ol>
Function <b>NOT supported</b> by the server: 
<ol>
  <li>Comparing two different snapshots. This is a function inside client part, and user
  can do it using Python interface.</li>
  <li>Comparing an archived snapshot with current live machine. This is a function 
  inside client part, and is supported in PyQt4 GUI by default.</li>
  <li>Restoring machine to a particular snapshot status. The MASAR server has 
  unidirectional access to EPICS V3 IOC, which means reads value only. Restoring is
  a function inside client part, and is supported in PyQt4 GUI by default.</li>
  <li>Change pv name. We thought about pv name changes, but do not support
    this function at current release.</li>
  <li>Add new pv name to existing configuration. We thought about adding a new
    pv name to a group, but do not support it at current release. Since adding a new
    pv is changing the configuration definition in fact, it is encouraged to create a new
    configuration. Please refer 
    "Database configuration" section about how to create a new configuration. User 
    is encouraged to define a new configuration, then ask service manager or database 
    administrator to load the configuration into database. </li>
  <li>Reuse configuration name. We have a request that new group maintains old
    group name and old group becomes deprecated. But this is not in the initial 
    implementation.</li>
  <li>Version control for configuration changes. We considered to adopt version
    control to tracking configuration changes, for example, adding a new pv to
    existing pv_group, changing group name, and so on. But this is not in the initial 
    implementation.</li>
</ol>

<h3 id="dataformat">Data Format </h3>

<p>When a MASAR request is sent from client to server, NTNameValue type is used
to carry parameters, which is as below: </p>
<pre>structure NTNameValue<br>   string[]    names<br>   string[]    values<br>   string      function xxxxxx // function name as above</pre>
The name/value pair is converted into a Python dictionary inside service layer,
and transferred to PYMASAR/PYIRMIS layer. Acceptable names for above 6
functions are listed as below: 
<pre>retrieveServiceConfigProps:<br>        names = ["propname", "servicename", "configname"]<br>retrieveServiceConfigs:<br>        names = ["servicename", "configname", "system"]<br>retrieveServiceEvents:<br>        names = ["configid", "start", "end", "comment", "user"]<br>retrieveSnapshot: <br>        names = ["eventid", "start", "end", "comment"]<br>saveSnapshot:<br>        names = ["servicename","configname","comment"]<br>updateSnapshotEvent:<br>        names = ["eventid", "user", "desc"]</pre>

<p>The results from server are carried using a NTTable as below: </p>
<pre>structure NTTable<br>    structure timeStamp<br>        long secondsPastEpoch 0<br>        int nanoSeconds 0<br>        int userTag 0<br>    structure alarm<br>        int severity 0<br>        int status 0<br>        string message <br>    string[] label [...]<br>    ... // value field </pre>

<h2 id="database">Relational Database </h2>

<h3 id="sqlite3">SQLite3 Schema </h3>
Currently, SQLite3 is the only database supported by MASAR service. Its
original schema is inherited from IRMIS, and now is as below: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/masar-sqlite-eer.png" height="360" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR SQLite3 Schema</td>
    </tr>
  </tbody>
</table>

<h3 id="irmis">IRMIS Schema </h3>
When IRMIS support is implemented the DSL layer will make switching between the
different relational database almost seamless. However the database schemas
must be similar. For example to minimize the effort when switching from SQLite
to IRMIS, the IRMIS schema will be similar to the SQLite3 schema. 

<table>
  <tbody>
    <tr>
      <td><img src="masar/masar-eer.png" height="480" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR IRMIS Schema</td>
    </tr>
  </tbody>
</table>

<h3 id="createdb">Create Database </h3>

<p>This section is for <b>SQLite3</b> database only. The files for SQL are
located in directory:</p>
<pre>masarService/python/pymasar/db</pre>

<p>The generated data base will be stored in a place You specify. You also need
to create a directory that holds text files that each has a list of V3 channel
names. There is an example directory located in:</p>
<pre>masarService/example</pre>

<p>It has a subdictory pvs that has example channel list files. For example
pvs/example.txt contains:</p>
<pre>masarExample0000<br>masarExample0001<br> ...<br>masarExample0999</pre>

<p>The SQL file is masars-qlite.sql. File createmasardb.py is the Python
script that create an SQLite3 database. An example of how to create a MASAR
database is:</p>
<pre>$cd masarService/example<br>$python ../python/pymasar/db/createmasardb.py</pre>
This creates a new MASAR database called "masar.db" that is located in the
example directory. If there is an error like: 
<pre>create a new SQLite db.<br>Traceback (most recent call last):<br>  File "../python/pymasar/db/createmasardb.py", line 109, in &lt;module&gt;<br>    createMasarDb()<br>  File "../python/pymasar/db/createmasardb.py", line 59, in createmasardb<br>    from pymasar.db.masarsqlite import SQL<br>ImportError: No module named pymasar.db.masarsqlite</pre>
Check the PYTHONPATH setting. 

<p>If the "masar.db" exists already, you will be asked </p>
<pre>SQLite database masar.db exists already.<br>Do you want to overwrite it? Yes, [N]o (default = No):</pre>

<p>Choose Yes to overwrite current masar.db file, otherwise No. </p>

<p>If you want to give database file a name instead of using default "masar.db",
you can do </p>
<pre>$ python ../python/pymasar/db/createmasardb.py -db test.db<br>SQLite3 database:  test.db<br>create a new SQLite db: test.db.</pre>

<p>After created MASAR database, an environment variable needs to be set as
(BASH environment) </p>
<pre>export MASAR_SQLITE_DB=~/V4/masarService/example/masar.db</pre>
If the database is named differently, use right database file name. 

<h3 id="configdb">Database configuration </h3>

<p>This section is also only for an SQLite3 database and again the files
described below are located in:</p>
<pre>masarService/python/pymasar/db</pre>

<p>After creating the SQLite3 database, it has to be initialized, and some
information about service configuration have to be configured in advance before
allowing MASAR server uses it. </p>

<p>The database configuration, which is an administrative work, is separated
from MASR service, and could be done through calling PYMASAR API. A Python
Script, configmasardb.py, initializes and configures the database. This is also located in:</p>
<pre>masarService/python/pymasar/db</pre>

<p>The following is an example showing how to configure MASAR database. </p>

<p>Site-specific information is configured in settings.py, which has format as
below: </p>
<pre># pv group name: [pv list file, description]<br>pvgroups= {<br>    'test':         ['example.txt', 'server test'],<br>    'wftest':       ['exampleWf.txt', 'server test with waveform'],<br>    'bigwftest':    ['exampleBigWf.txt', 'server test with big waveform']<br>}<br><br># config name: [config desc, system]<br>configs= {<br>    'sr_test':      ['test pv config', 'test'],<br>    'wf_test':      ['waveform test pv config', 'test'],<br>    'bwf_test':     ['big waveform test pv config', 'test']<br>}<br><br># config name: [pvgroup,]<br>pvg2config= {<br>    'sr_test':   ['test'],<br>    'wf_test':   ['wftest'],<br>    'bwf_test':  ['wftest', 'bigwftest']<br>}</pre>

<p>There are 3 variables defined in settings.py </p>
<ol>
  <li><b>pvgroups</b>. A Python dictionary with group name as key. Each pv
    group is a collection of V3 channel names. The value is a the name of a
    file that holds a list of channel names and configuration description. The
    pv group name has to be global unique.</li>
  <li><b>configs</b>. It is a Python dictionary with configure name as key.
    Each config has a Python list as its value, which includes configure
    description, and which system it belongs to. The config name has to be
    global unique. </li>
  <li><b>pvg2config</b>. It is a Python dictionary with configure name as key.
    The value of each key is a collection list of pv group name. </li>
</ol>

<p>After the settings.py is configured, configmasardb.py creates the database.
Assume the database is called masar.db, and is located in
masarService/example</p>
<pre>$ python ../python/pymasar/db/configmasardb.py</pre>
it requests the absolute path of pv list file directory. 
<pre>Please give absolute ROOT PATH of your pv list files <br>[default: /home/xxxx/V4/masarService/python/pymasar/db/pvs]:</pre>
here give the pv list directory PATH, for example
/home/xxxx/V4/masarService/pvs: 
<pre><span style="color: rgb(204, 0, 0);">/home/xxxx/V4/masarService/example/pvs</span>
Use new ROOT: /home/xxxx/V4/masarService/example/pvs</pre>

<p>If the path is wrong, it raises an exception. After loading pv names into
database, it tries to save configuration. If a configuration exists already, it
reports for example, and ignores that configuration: </p>
<pre>configuration name (bwf_test) exists already.<br>configuration name (sr_test) exists already.<br>configuration name (wf_test) exists already.</pre>

<p>After finished the database configuration, it is ready to launch MASAR
server. </p>

<h2 id="installation">Install from source</h2>
<p>At current stage, all EPICS V4 packages are available as source code, which
can be checked out from by sourceforge mercurial repository. To compile all V4
module Python 2.7 and EPICS V3 development packages must be installed. EPICS V3
base is available as a Debian package from <a href="http://epics.nsls2.bnl.gov/debian/">NSLS-II Debian package server</a>.
Here we assume EPICS V3 base is installed under <span style="color: rgb(0, 153, 0);">/usr/lib/epics</span>. </p>

<p>
A step-by-step installation is introduced here, and the example is to show how
to install whole packages on Ubuntu 11.04 x86_64 system. You should be able to
install all modules on other systems following the same procedure. You can
check your system architecture using for example on linux: 
</p>
<pre>$ uname -m<br>x86_64<br></pre>

<h3 id="prepareinstall">Preparation</h3>
Here we assume you want to install all modules under ~/V4<br>

<pre>$ cd<br>$ mkdir V4<br>$ cd V4<br>$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/pvDataCPP<br>$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/pvAccessCPP<br>$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/pvIOCCPP<br>$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/alphaCPP<br><br>$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/masarService<br></pre>

<p>If you are inside an internal network, and have some proxy setting, you might hit a
connection error during cloning a module like:
</p><pre>abort: error: Connection refused</pre>
Please consulate your network manager, or you can try to set your
http_proxy environment, for example, on BASH shell: 
<pre>export http_proxy=http://your.proxy.server.name:port</pre>

NOTE: Make sure you have following line in each module in configure/RELEASE.
Suggest to put it as the last line if it is not. 
<pre>-include $(TOP)/configure/RELEASE.local</pre>

<h3 id="pvdatainstall">Install pvDataCPP </h3>
<pre>$ cd pvDataCPP</pre>
Add the following to configure/RELEASE.local 
<pre>EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3 id="pvaccessinstall">Install pvAccessCPP</h3>
<pre>$ cd ../pvAccessCPP </pre>
Add the following to configure/RELEASE.local 
<pre>PVDATA=~/V4/pvDataCPP<br>EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3 id="pviocinstall">Install pvIOCCPP </h3>
<pre>$ cd ../pvIOCCPP</pre>
Add the following to configure/RELEASE.local 
<pre>PVDATA=~/V4/pvDataCPP<br>PVACCESS=~/V4/pvAccessCPP<br>EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3 id="ntinstall">Install normativeTypes</h3>
<pre>$ cd ../alphaCPP/normativeTypes/</pre>
Add the following to configure/RELEASE.local 
<pre>PVDATA=~/V4/pvDataCPP<br>PVACCESS=~/V4/pvAccessCPP<br>EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3 id="masarinstall">Install masarService </h3>
<pre>$ cd ../../masarService/cpp</pre>
Add the following to configure/RELEASE.local 
<pre>PYTHON=python2.7<br>PYTHON_BASE=/usr<br>$(PYTHON)_DIR = $(PYTHON_BASE)/lib/$(PYTHON)/config <br>NUMPY_CORE=${PYTHON_BASE}/lib/${PYTHON}/site-packages/numpy/core<br><br>PVDATA=~/V4/pvDataCPP<br>PVACCESS=~/V4/pvAccessCPP<br>PVIOC=~/V4/pvIOCCPP<br>NTTYPE=~/V4/alphaCPP/normativeTypes<br><br>EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>
The installation procedure is complete if the above is successful. 

<h2 id="runserver">Run MASAR Server </h2>

<p>After installing all required modules and configuring the sql database the
last step is to prepare and check the Python environment. </p>

<h3 id="pythonc">Python/C module</h3>
Python looks for the shared library to load modules. You need to create some
symbol links if it is not done yet. 
<pre>$ cd<br>$ cd ~/V4/masarService/cpp/src/python<br>$ python generateSOLinks.py</pre>
If you did not set EPICS_HOST_ARCH environment, you will be promoted as below: 
<pre>EPICS_HOST_ARCH is not setted.<br>Please specify EPICS_HOST_ARCH:</pre>

<p>You can specify your host architecture here, for example, linux-x86_64 if
you are using a 64-bit linux machine. An error will occur as below if the
EPICS_HOST_ARCH is wrong: </p>
<pre>EPICS_HOST_ARCH is not setted.<br>Please specify EPICS_HOST_ARCH:linux-x86<br>Traceback (most recent call last):<br>  File "generateSOLinks.py", line 32, in &lt;module&gt;<br>    fileList = os.listdir(libDir)<br>OSError: [Errno 2] No such file or directory: '../../lib/linux-x86'</pre>

<p>An alternative solution is to set the environment before running
generateSOLinks.py, for example:<br>
</p>
<pre>$ export EPICS_HOST_ARCH=linux-x86_64</pre>

<h3 id="pythonpath">PYTHONPATH</h3>
The PYTHONPATH must be defined as follows. It could be defined in .bash_profile 
<pre>$ export PYTHONPATH=~/V4/masarService/python<br>$ export PYTHONPATH=${PYTHONPATH}:~/V4/masarService/cpp/src/python<br></pre>

<h3 id="masardb">MASAR SQLite database</h3>
You also need to set the MASAR_SQLITE_DB to allow PYMASAR module to find the
SQLite3 database. Here is an example. It can also be put in .bash_profile
<pre>$ export MASAR_SQLITE_DB=~/V4/masarService/example/masar.db</pre>

<p>Now it is ready to go. </p>

<h3 id="launchserver">Launch MASAR service</h3>

<p>The following packages are needed to run MASAR server.</p>
<ul>
  <li>Python 2.7 or above</li>
  <li>SQLite3 3.7 or above</li>
</ul>
<pre>$ cd ~/V4/masarService/cpp<br>$ ./bin/linux-x86_64/masarServiceRun</pre>
You will see the following output 
<pre>ChannelBaseProvider::ChannelBaseProvider pvService<br>VERSION : CA Server v0.9.0<br>PROVIDER_NAMES : pvService<br>BEACON_ADDR_LIST : <br>AUTO_BEACON_ADDR_LIST : 1<br>BEACON_PERIOD : 15<br>BROADCAST_PORT : 5067<br>SERVER_PORT : 5066<br>RCV_BUFFER_SIZE : 16384<br>IGNORE_ADDR_LIST: <br>STATE : INITIALIZED<br>masarService<br>Type exit to stop: </pre>

<p>You have started the server now successfully. However, if you see this
output: </p>
<pre>ChannelBaseProvider::ChannelBaseProvider pvService<br>VERSION : CA Server v0.9.0<br>PROVIDER_NAMES : pvService<br>BEACON_ADDR_LIST : <br>AUTO_BEACON_ADDR_LIST : 1<br>BEACON_PERIOD : 15<br>BROADCAST_PORT : 5067<br>SERVER_PORT : 5066<br>RCV_BUFFER_SIZE : 16384<br>IGNORE_ADDR_LIST: <br>STATE : INITIALIZED<br><span style="color: rgb(204, 0, 0);">DSL_RDB::init dslPY does not exist or is not a python module</span>
masarService
Type exit to stop: </pre>

<p>which means either the PYTHONPATH is not set correctly, or MASAR can not
find. Check the MASAR_SQLITE_DB and PYTHONPATH. </p>

<h3 id="launchserver2">Launch MASAR with other name</h3>
Above description explains how to launch MASAR service with default name. Since
a client uses the name to communicate with server, the server name can be given
when launching it as below, for example to name the RPC channel as
"MASARSERVICE:TEST:EXAMPLE": 
<pre>$ cd ~/V4/masarService/cpp<br>$ ./bin/linux-x86_64/masarServiceRun MASARSERVICE:TEST:EXAMPLE</pre>
it will shows 
<pre>ChannelBaseProvider::ChannelBaseProvider pvService<br>VERSION : CA Server v0.9.0<br>PROVIDER_NAMES : pvService<br>BEACON_ADDR_LIST : <br>AUTO_BEACON_ADDR_LIST : 1<br>BEACON_PERIOD : 15<br>BROADCAST_PORT : 5067<br>SERVER_PORT : 5066<br>RCV_BUFFER_SIZE : 16384<br>IGNORE_ADDR_LIST: <br>STATE : INITIALIZED<br><span style="color: rgb(204, 0, 0);">MASARSERVICE:TEST:EXAMPLE</span>
Type exit to stop: </pre>

<h3 id="stopserver">Stop MASAR service</h3>

<p>To stop server, type "exit" and you will get the following message: </p>
<pre>Type exit to stop: <br>exit<br>ServiceChannelRPC::~ServiceChannelRPC()<br>MasarService::destroy()<br>PVServiceProvider::unregister<br>PVServiceProvider::~PVServiceProvider<br>PVServiceProvider::destroy<br>void PVTop::destroy()<br>PVTop::~PVTop()<br>MasarService::~MasarService()<br>close SQLite3 connection.<br>ChannelBaseProvider::~ChannelBaseProvider<br>timerNode:  totalConstruct 1 totalDestruct 1<br>blockingUDPTransport:  totalConstruct 1 totalDestruct 1<br>timer:  totalConstruct 1 totalDestruct 1<br>LinkedList:  totalConstruct 4 totalDestruct 4<br>LinkedListNode:  totalConstruct 6 totalDestruct 6<br>event:  totalConstruct 5 totalDestruct 5</pre>

<h2 id="masarclient">MASAR Client </h2>
There are 2 ways to use MASAR client, using either the Python API or the
default PyQt4 GUI. 

<h3 id="pythonapi">Python API </h3>
The client API is defined in masarClient.py. 
<ol>
<li>client.<b>retrieveSystemList</b>()</li>
<p>
Retrieve all system and return as a list, or False if failed. 
An example:
</p><p>
Example:
</p><pre>import sys<br><br>from masarclient import masarClient<br>from masarclient.channelRPC import epicsExit<br><br># Assume the service name is masarService<br># Consulate server manager to confirm it.<br>channel='masarService'<br><br># initialize a masar client<br>mc = masarClient.client( channelname = channel)<br><br># retrieve all system defined in masar configuration<br>print '==== retrieve system list ===='<br>result = mc.retrieveSystemList()<br>print result<br><br># Call this function before exit.<br>sys.exit(epicsExit())<br></pre>



<li>
client.<b>retrieveServiceConfigs</b>(params)
</li>
<p>
Retrieve all configuration information. The params is as a dictionary which can
have any combination of the following keys:<br>
key names: </p>
<pre>["servicename", "configname", "system"]</pre>
It returns all configurations that satisfies the search constrains, or False if
failed:<br>

<pre>config id []<br>config name []<br>config description []<br>version []<br></pre>
The version is a reserved function for future. 
<p>
Example:
</p><pre>import sys<br><br>from masarclient import masarClient<br>from masarclient.channelRPC import epicsExit<br><br># Assume the service name is masarService<br># Consulate server manager to confirm it.<br>channel='masarService'<br><br># retrieve all configuration with given constrains<br># In this example, all configurations belonging to system "LTD2" <br># are retrieved from RDB.<br>print '==== retrieve service config ===='<br>params = {'system': 'LTD2'}<br>result = mc.retrieveServiceConfigs(params)<br>print result<br><br># Call this function before exit.<br>sys.exit(epicsExit())<br></pre>

<li>client.<b>retrieveServiceEvents</b>(params)</li>
<p>
Retrieve all events including event id, user comment, user name, and UTC
time.<br>
It retrieves all events without any V3 IOC data. The params is as a dictionary
which can have any combination of the following keys:<br>
key names: </p>
<pre>["configid", "start", "end", "comment", "user"]</pre>
The value of each key needs to be a string. The "start" and "end" is for time
range in UTC format.<br>
It returns all event list that satisfies the search constrains, or False if
failed:<br>

<pre>event id []<br>event description []<br>UTC date time  []<br>author/user []</pre>
<p>
Example:
</p><pre>import sys<br><br>from masarclient import masarClient<br>from masarclient.channelRPC import epicsExit<br><br># Assume the service name is masarService<br># Consulate server manager to confirm it.<br>channel='masarService'<br><br># retrieve all events list with given constrains<br># In this example, all events belonging to configuration which has configid ("1")<br># are returned.<br>print '==== retrieve service config ===='<br>params = {'configid': '1'}<br>result = mc.retrieveServiceEvents(params)<br>print result<br><br># Call this function before exit.<br>sys.exit(epicsExit())<br></pre>

<li>client.<b>retrieveSnapshot</b>(params)</li>
<p>Retrieve a particular snapshot, which is flagged to be an approved snapshot,
with all pv data.<br>
The params is as a dictionary which can have any combination of the following
keys:<br>
key names: </p>
<pre>["eventid", "start", "end", "comment"]</pre>
The value of each key needs to be a string. The "start" and "end" is for time
range in UTC format.<br>
It returns snapshot that satisfies the search constrains, or False if failed: 
<pre>pv name []<br>string value []<br>double value []<br>long value []<br>dbr_type []<br>isConnected []<br>secondsPastEpoch []<br>nanoSeconds []<br>alarmSeverity []<br>alarmStatus []<br>is_array []<br>array_value [[]]</pre>
For a scalar pv, its value is carried in string, double and long. For a
waveform/array, its value is carried in array_value. Client needs to check the
pv is an array by checking is_array, and check its data type by checking
dbr_type. 
<pre>        # DBR_TYPE definition defined in db_access.h<br>        #define DBF_STRING      0<br>        #define DBF_INT         1<br>        #define DBF_SHORT       1<br>        #define DBF_FLOAT       2<br>        #define DBF_ENUM        3<br>        #define DBF_CHAR        4<br>        #define DBF_LONG        5<br>        #define DBF_DOUBLE      6<br>        #define DBF_NO_ACCESS   7<br><br>        # type mapping in python<br>        epicsLong   =   [1, 4, 5]<br>        epicsString =   [0, 3]<br>        epicsDouble =   [2, 6]<br>        epicsNoAccess = [7]</pre>

<p>
Example:
</p><pre>import sys<br><br>from masarclient import masarClient<br>from masarclient.channelRPC import epicsExit<br><br># Assume the service name is masarService<br># Consulate server manager to confirm it.<br>channel='masarService'<br><br># retrieve snapshot data which event id = "1"<br># It return false if there isn't such snapshot.<br>print '==== retrieve snapshot ===='<br>params = {'eventid': '1'}<br>result = mc.retrieveSnapshot(params)<br>print result<br><br># Call this function before exit.<br>sys.exit(epicsExit())<br></pre>


<li>client.<b>saveSnapshot</b>(params)</li>
<p>
This function is to take a machine preview. It gives user a opportunity to confirm
whether the snapshot is good or not. The data will be saved into database with a default
flag to identify that this preview is not approved by the user yet. 
The params is as a dictionary which can have any combination of the following
keys:<br>
(key names): </p>
<pre>["servicename","configname","comment"]</pre>
The value of each key needs to be a string. It saves all data into database,
and returns the same data back to the client, which means the return data is
same the retrieveSnapshot function. 
<p>
Example:
</p><pre>import sys<br><br>from masarclient import masarClient<br>from masarclient.channelRPC import epicsExit<br><br># Assume the service name is masarService<br># Consulate server manager to confirm it.<br>channel='masarService'<br><br># get a machine preview and save it into database<br># for configuration with name = 'LTD2_SC_Daily_All'<br>print '==== machine preview snapshot ===='<br>params = {'configname': 'LTD2_SC_Daily_All',<br>          'servicename': 'masar'}<br>result = mc.saveSnapshot(params)<br>print result<br><br># Call this function before exit.<br>sys.exit(epicsExit())<br></pre>

<li>client.<b>updateSnapshotEvent</b>(params)</li>
<p>Flag a particular snapshot to be approved..<br>
The params is as a dictionary which can have any combination of the following
keys:<br>
key names: </p>
<pre>["eventid", "user", "desc"]</pre>
The value of each key needs to be a string. It returns True if succeeded,
otherwise, false. 
<p>
Example:
</p><pre>import sys<br><br>from masarclient import masarClient<br>from masarclient.channelRPC import epicsExit<br><br># Assume the service name is masarService<br># Consulate server manager to confirm it.<br>channel='masarService'<br><br># approve a machine preview which event id = '1'<br># it returns false if there is no event found with id='1'<br>print '==== approve machine preview snapshot ===='<br>params = {'eventid':    '1',<br>          'user':       'test',<br>          'desc':       'this is a good snapshot, and I approved it.'}<br>result = mc.updateSnapshotEvent(params)<br>print result<br><br># Call this function before exit.<br>sys.exit(epicsExit())<br></pre>

<li>client.<b>getLiveMachine</b>(params)</li>
<p>
Get live data with given pv list. Following the same params format, it uses pv
name as both key and value. It returns </p>
<pre>pv name []<br>string value []<br>double value []<br>long value []<br>dbr_type []<br>isConnected []<br>is_array []<br>array_value [[]]</pre>
Same as retrieveSnapshot function, for a scalar pv, its value is carried in
string, double and long. For a waveform/array, its value is carried in
array_value. Client needs to check the pv is an array by checking is_array, and
check its data type by checking dbr_type. 
<p>
Example:
</p><pre>import sys<br><br>from masarclient import masarClient<br>from masarclient.channelRPC import epicsExit<br><br># Assume the service name is masarService<br># Consulate server manager to confirm it.<br>channel='masarService'<br><br># get a live machine with given pv list<br>print '==== get live machine ===='<br>pvlist = ['LTB-BI{BPM:1}LTB:MbAvgX-I',<br>          'LTB-BI{BPM:1}LTB:MbStdX-I',<br>          'LTB-BI{BPM:1}LTB:MbAvgY-I',<br>          'LTB-BI{BPM:1}LTB:MbStdY-I',<br>          'LTB-BI{BPM:1}LTB:Iavg-Calc',<br>          'LTB-BI{BPM:1}LTB:Istd-Calc',<br>          'LTB-BI{BPM:1}Rate:Update-SP',<br>          'LTB-BI{BPM:2}LTB:MbAvgX-I',<br>          'LTB-BI{BPM:2}LTB:MbStdX-I',<br>          'LTB-BI{BPM:2}LTB:MbAvgY-I',<br>          'LTB-BI{BPM:2}LTB:MbStdY-I',<br>          'LTB-BI{BPM:2}LTB:Iavg-Calc',<br>          'LTB-BI{BPM:2}LTB:Istd-Calc',<br>          'LTB-BI{BPM:2}Rate:Update-SP']<br><br># formalize the params<br>for pv in pvlist:<br>    params[pv] = pv<br>result = mc.getLiveMachine(params)<br>print result<br><br># Call this function before exit.<br>sys.exit(epicsExit())<br></pre>

</ol>
<h3 id="clientgui">Default GUI </h3>
A default GUI is developed using PyQt4. A start script can be found under
masarService/cpp. Here assume the MASAR server has been started with the name
"MASARSERVICE:TEST:EXAMPLE". Client GUI can be launched as below: 
<pre>$ python masar MASARSERVICE:TEST:EXAMPLE</pre>
A GUI will be launched as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MasarViewer.png" height="380" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Main Page</td>
    </tr>
  </tbody>
</table>
If it can not connect to the MASAR server, a warning dialog will pop up as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MasarNoService.png" height="166" width="420"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR No Service Dialog</td>
    </tr>
  </tbody>
</table>
If server is connected successfully, all systems are available as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARSystem.png" height="375" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">System selection</td>
    </tr>
  </tbody>
</table>
After selected desired system, click on "Fetch Config(s)" button, all
configurations for selected system are retrieved from database and shown in
configure table as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARConfig.png" height="375" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Configuration List</td>
    </tr>
  </tbody>
</table>
To select a configuration, click on a row on the configure table, or hold Ctrl
key if using for example Linux, or Command key for MAC OS-X + click on
different row to select multiple configurations. User is able also to filter
the event description, author/user name, and time range.<br>
After selected configure(s), click on "Fetch Event(s)" button to retrieve event
list. 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASAREvent.png" height="375" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Event List</td>
    </tr>
  </tbody>
</table>
If the event table shows nothing above, it means there is no qualified event
snapshot for that configuration with given constrains.<br>
<br>
To take a machine snapshot, select one configuration, then click on "Preview
Button". A machine preview will be taken, and get a result like: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARPreview.png" height="375" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Snapshot Preview</td>
    </tr>
  </tbody>
</table>
If there is nothing showing up, it means probably no pv can be connected.<br>
After verifying the preview, click "Save Current Preview" button to flag this
preview approved. A dialog will pop up to confirm as below: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARSavePreviewDlg.png" height="243" width="500"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Approval Dialog</td>
    </tr>
  </tbody>
</table>
By clicking "Yes", a comment dialog will pop up to ask for Author for who does
this, and comment as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARPreviewComment.png" height="316" width="496"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Snapshot Comment</td>
    </tr>
  </tbody>
</table>
Click "OK" after done. A success message dialog will show up as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARPreviewDone.png" height="243" width="382"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Snapshot Approved</td>
    </tr>
  </tbody>
</table>
After saved it, it should appear in event table as follow if clicking "Fetch
Snapshot(s)" and make sure correct time range if "Use time range" is checked. 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARSnapshot.png" height="387" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Snapshot</td>
    </tr>
  </tbody>
</table>
It can be selected, and appear on right side window by clicking "Fetch
Snapshot".<br>
<br>
To compare a snapshot with live machine, just click "Compare Live Machine"
button, and all live data will display on the same window for all available pv
data as below: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARCompare.png" height="387" width="480"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Compare a Snapshot With Live
      Machine</td>
    </tr>
  </tbody>
</table>
The difference between snapshot and live machine will be calculated for a
scalar pv. For an array pv, a pop-up dialog will be displayed by double
clicking on either "Saved Value" cell or "Live value" cell as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARArrayCompare.png" height="302" width="188"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Compare Array PV</td>
    </tr>
  </tbody>
</table>
It will display how many points in saved data, and how many in live data, and
detailed data value.<br>
To restore the machine, select one snapshot, and click "Restore Machine"
button. <br>
If for any reasons, an operator does not want to restore all pvs, the
operation can be done by checking some pv as below (the masarExample001
will not be restored.):<br>
<div style="text-align: center;"><img style="width: 600px; height: 432px;" alt="" src="masar/NoRestoreSelectedPv.png"><br>
</div>
A dialog will be poped up as below to confirm this operation since it might be dangerous.<br>
<div style="text-align: center;"><img style="width: 500px; height: 243px;" alt="" src="masar/NoRestoreAll.png"><br>
</div>
<br>
After finished restoring, a dialog will pop up to show either succeed to restore machine or fail
as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARRestore.png" height="243" width="500"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Restore Confirmation</td>
    </tr>
  </tbody>
</table>
The restore result can be confirmed by comparing the live machine again as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARCompareAfterRestore.png" height="529" width="714"></td>
    </tr>
    <tr>
      <td style="text-align: center;">MASAR Compare Restore Result</td>
    </tr>
  </tbody>
</table>The data can be saved into a local file by clicking "Save to File" button as below:<br>
<div style="text-align: center;"><img style="width: 714px; height: 566px;" alt="" src="masar/SaveFile.png"><br>
</div>
A dialog window will pop up to ask where which file the data should be saved into.<br>

<hr>
<address>
  Guobao Shen, BNL 
</address>
<!-- hhmts start -->
Last modified: Mon, 26 Mar 2012 15:38:50 -0400<!-- hhmts end -->
<hr>
</body></html>