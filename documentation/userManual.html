<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="keywords" content="EPICS, EPICSv4">
  <!-- Include the epicsv4 base.css, and the css for epics v4 documents -->
  <link rel="stylesheet" type="text/css"
  href="http://epics-pvdata.sourceforge.net/base.css">
  <link rel="stylesheet" type="text/css"
  href="http://epics-pvdata.sourceforge.net/epicsv4.css">
  <title>MASAR User Manual</title>
  <style type="text/css">
/*<![CDATA[*/


/*]]>*/</style>
</head>

<body>

<div class="head">
<h1>MASAR USER MANUAL<br>
</h1>
<!-- Maturity: Working Draft or Request for Comments, or Recommendation, and date. -->

<h2 class="nocount">MASAR User Manual, Editors Draft, 13-Mar-2012</h2>
<dl>
  <dt>This version:</dt>
    <dd><a
      href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/masarService/raw-file/tip/documentation/userManual.html">userManual_20120309.html</a></dd>
  <dt>Latest version:</dt>
    <dd><a
      href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/masarService/raw-file/tip/documentation/userManual.html">userManual.html</a></dd>
  <dt>Editors:</dt>
    <dd>Guobao Shen, BNL<br>
      Marty Kraimer, BNL<span style="font-weight: bold;"></span></dd>
</dl>
<dl>
</dl>
<hr>
</div>
<!-- Header material -->

<h2 class="nocount" id="abstract">Abstract</h2>

<p>MASAR (MAchine Snapshot, Archiving, and Retrieve) is an EPICS V4 service.
The server and client are implemented in C++ and Python. The server takes
machine snapshots, archives data in a relational database, and retrieves data
from the database. The client provides a GUI that retrieves data, compares data
with the live machine, and restores the machine with given snapshot data. The
client also provides support for other python and C++ code.</p>

<p>The server takes machine snapshot by using pre-defined configurations. To
take a snapshot the client specifies the name of the snapshot configuration and
a name for this snapshot event.When the server receives a command to take a
machine snapshot, the server retrieves, from the database, the list of V3
channel names for the configuration. It then gets the current value of all the
channels from V3 IOC, and saves the data as a snapshot event into the database.
</p>

<h2 class="nocount" id="status">Status of this Document</h2>

<p>This is the 13-Mar-2012 version of the MASAR User Manual. </p>

<h2>Introduction</h2>

<p>MASAR is implemented in C++ and Python. Network communication is implemented
via the EPICS V4 channelRPC mechanism . The current implementation uses SQLite3
for the relational database. A Python module PYMASAR provides access to
SQLite3. </p>

<p>Since EPICS V4 channelRPC server is implemented in C++, the interface
between the masar server and PYMASAR is implemented using Python/C. A Python
API is provided for the client user, and a default PyQt4 GUI is developed for
end user.</p>

<p>The products are all part of the <a
href="http://epics-pvdata.sourceforge.net">V4</a> implementation of <a
href="http://www.aps.anl.gov/epics">Experimental Physics and Industrial Control
System</a>, which are available via an <a
href="http://epics-pvdata.sourceforge.net/LICENSE.html">open source
license</a>. </p>

<p>For now the only way to obtain the MASAR service is from the sourceforge
mercurial repository. No binary package is currently provided. Like other EPICS
V4 modules, MASAR service can be checked out from its mercurial repository on
source forge.</p>

<p><span style="color:#ff0000">GUOBAO IS THE FOLLOWING NECESSARY</span> If
there is an error such as </p>
<pre>abort: error: Connection refused</pre>
during checking out, it probably means that you have some problems with your
network setting, for example http proxy setting. You can try to set your
http_proxy environment, for example, on BASH shell: 
<pre>export http_proxy=http://your.proxy.server.name:port</pre>

<h2>System Requirement</h2>

<p>To run MASAR on you machine, Python and various EPICS V3 and V4 run-time
library are required for both client and server. </p>

<p>Python: </p>
<ul>
  <li>Python 2.7 or above</li>
</ul>

<p>EPICS modules: </p>
<ul>
  <li>EPICS V3 base R3.14.11 or above. Current release is R3.14.2, which can be
    downloaded from <a
    href="http://www.aps.anl.gov/epics/base/R3-14/12.php">here</a>.<br>
  </li>
  <li><a href="http://epics-pvdata.sourceforge.net/">EPICS V4</a> (managed by
    mercurial on source forge)<br>

    <ul>
      <li><a
        href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/pvDataCPP/raw-file/tip/documentation/pvDataCPP.html">pvDataCPP</a>
      </li>
      <li><a
        href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/pvAccessCPP/raw-file/tip/documentation/pvAccessCPP.html">pvAccessCPP</a>
      </li>
      <li><a
        href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/pvIOCCPP/raw-file/tip/documentation/pvIOCCPP.html">pIOCCPP</a></li>
      <li><a
        href="http://epics-pvdata.sourceforge.net/alpha/normativeTypes/normativeTypes.html">normativeTypes</a><br>
        The normative types implementation is under alpha version, which is
        under alphaCPP module.</li>
      <li><a
        href="http://epics-pvdata.hg.sourceforge.net/hgweb/epics-pvdata/masarService/raw-file/tip/documentation/userManual.html">masarService</a>
      </li>
    </ul>
  </li>
</ul>

<p>For MASAR server, you need:</p>
<ul>
  <li>SQLite3 3.7 or above</li>
</ul>

<p>For MASAR client default GUI:</p>
<ul>
  <li>PyQt4 4.8 or above</li>
</ul>

<p>Currently, MASAR has been installed on the following systems:</p>
<ul>
  <li>Ubuntu 11.04 (Natty Narwhal)<br>
  </li>
  <li>Debian 7.0 (Wheezy)</li>
  <li>Fedora 14</li>
  <li>Fedora 16</li>
  <li>Mac OS-X 10.6.8 (Snow Leopard)<br>
  </li>
</ul>

<p></p>

<h2>Terminology</h2>
in addition to the terminology used by EPICS, MASAR defines the following: 
<ul>
  <li>pv group: A unique group.It has a name, list of V3 channel names,
    description, and date when group was created.</li>
  <li>service config: A unique configuration. It has a name, pv group name,
    description, and syatem to which system it belongs. </li>
  <li>system: Identifies the sub system to which each configuration
  belongs.</li>
  <li>service event: Description of a snapshot. It has comment, author name,
    date, and status;</li>
  <li>snapshot: The data for a snapshot event.</li>
  <li>interface name convention 
    <ul>
      <li>putXXXX(): put into a live machine, more specifically, an EPICS live
        pv</li>
      <li>getXXXX(): get from a live machine, more specifically, an EPICS live
        pv</li>
      <li>saveXXX(): save into a RDB</li>
      <li>retrieveXXX(): retrieve from a RDB</li>
    </ul>
  </li>
</ul>

<h2>System Architecture</h2>
The MASAR consists of client and server : 

<table>
  <tbody>
    <tr>
      <td><img src="masar/masar.png" width="480" height="360"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Architecture</td>
    </tr>
  </tbody>
</table>

<p>The client has a client Python API library, which can be used by both Python
scripting, and the GUI. A default PyQt4 GUI is developed for data viewing,
snapshot taking, comparing a snapshot with live machine, and restoring machine
to a particular status using a snapshot. </p>

<p>The server has 4 layers: </p>
<ul>
  <li>Service communication control: the pvAccess channel RPC instance.</li>
  <li>Service: parses a command from the client, implements desired action, and
    returns the result to the client.</li>
  <li>Channel Access Client: For now the only usage to to get the current value
    of a set of V3 channels.</li>
  <li>DSL (data source layer): This is the interface between C++ and Python.
    <ul>
      <li>PYMASAR: A Python module to access SQLite3 database, which is
        supported by default currently;</li>
      <li>PYIRMIS: A Python module to access IRMIS/MySQL database, which will
        be supported in the future.</li>
    </ul>
  </li>
  <li>Data layer. 
    <ul>
      <li>IOC: live machine data;</li>
      <li>IRMIS: static data, which can have all machine configuration.</li>
      <li>MASAR: embedded inside PYMASAR, which is dedicated to MASAR
      service.</li>
    </ul>
  </li>
</ul>

<h2>MASAR Server</h2>
The MASAR server can take a snapshot for any combination of EPICS channels,
including scalar channels of type string, enum, byte (8-bit), short (16-bit),
int (32-bit), long (which is same with integer in EPICS V3), float, and double,
and/or waveform/array pv with any above types except enum. Since the data types
supported by both Python and SQLite3/IRMIS are string, int, and real, the types
are casted as below: 

<table>
  <tbody>
    <tr>
      <td style="text-align:center">epics data type</td>
      <td style="text-align:center">data type carried by MASAR</td>
    </tr>
    <tr>
      <td style="text-align:center">enum, string</td>
      <td style="text-align:center">string</td>
    </tr>
    <tr>
      <td style="text-align:center">byte, short, int/long</td>
      <td style="text-align:center">long</td>
    </tr>
    <tr>
      <td style="text-align:center">float, double</td>
      <td style="text-align:center">double</td>
    </tr>
  </tbody>
</table>
The waveform data is casted following above rule, and stored as a BLOB in
database after being serialized into binary. At current stage, the BLOB is one
field of masar_data table, and might be separated as a standalone table if
there is any performance issue. 

<p><b>NOTE</b>: </p>
<ol>
  <li>In the database time is stored as UTC/POSIX time, which means the IOC
    time, seconds past EPOCH has been shifted to POSIX time from V3 time which
    is relative to 1990 instead of 1970.</li>
  <li>All timestamps in service_event, service_config, and pv_group tables are
    the time when inserting data into database. This means that the time stamp
    for a particular snapshot is the time when the data is inserted into
    database.</li>
  <li>Since the enum is converted to a string, it captures its label (display
    value) instead of its real value(0, 1, ...). Advantage doing that is if
    there is any changes on enum label, it probably means some V3 IOC database
    logic has changed. It is better to throw a message to show that explicitly.
  </li>
</ol>

<h3>Functions </h3>

<p></p>

<p>The MASAR supports 6 fundamental functions: </p>
<ol>
  <li><b>retrieveServiceConfigProps</b>: get a list from RDB of many
    sub-systems are defined. <span style="color:#ff0000">GUOBAO I DO NOT
    UNDERSTAND WHAT THIS IS.</span></li>
  <li><b>retrieveServiceConfigs</b>: get a list of the snapshot configurations
    based on filter based on shapshot names..</li>
  <li><b>retrieveServiceEvents</b>: get a list how many snapshot events have
    been taken with filters based on snapshot names, author, and time
  range.</li>
  <li><b>retrieveSnapshot</b>: get real snapshot data;</li>
  <li><b>saveSnapshot</b>: save a snapshot into database;</li>
  <li><b>updateSnapshotEvent</b>: update a particular snapshot, for example
    flag a snapshot as approved;</li>
</ol>
Function <b>NOT supported</b> by the server: 
<ol>
  <li>Comparing two different snapshots or a archived snapshot with current
    live machine.</li>
  <li>Comparing an archived snapshot with current live machine (supported in
    default PyQt4 GUI).</li>
  <li>Restoring machine to a particular snapshot status (supported in default
    PyQt4 GUI). The MASAR server has unidirectional access to EPICS V3 IOC,
    which means reads value only.</li>
  <li>Change pv name. We thought about pv name changes, but we will not support
    this function.</li>
  <li>Add new pv name to existing configuration. We thought about adding a new
    pv name to a group, but will not support it currently. User is encouraged
    to create a new configuration. GUOBAO HOW DOES USER CREATE
  CONFIGURATION</li>
  <li>Reuse configuration name. We have a request that new group maintains old
    group name and old group becomes deprecated. But this will not be in
    initial implementation.</li>
  <li>Version control for configuration changes. We considered to adopt version
    control to tracking configuration changes, for example, adding a new pv to
    existing pv_group, changing group name, and so on. But this will not be in
    initial implementation.</li>
</ol>

<h3>Data Format </h3>

<p>When a MASAR request is sent from client to server, NTNameValue type is used
to carry parameters, which is as below: </p>
<pre>structure NTNameValue
   string[]    names
   string[]    values
   string      function xxxxxx // function name as above</pre>
The name/value pair is converted into a Python dictionary inside service layer,
and transferred to PYMASAR/PYIRMIS layer. Acceptable names for above 6
functions are listed as below: 
<pre>retrieveServiceConfigProps:
        names = ["propname", "servicename", "configname"]
retrieveServiceConfigs:
        names = ["servicename", "configname", "system"]
retrieveServiceEvents:
        names = ["configid", "start", "end", "comment", "user"]
retrieveSnapshot: 
        names = ["eventid", "start", "end", "comment"]
saveSnapshot:
        names = ["servicename","configname","comment"]
updateSnapshotEvent:
        names = ["eventid", "user", "desc"]</pre>

<p>The results from server are carried using a NTTable as below: </p>
<pre>structure NTTable
    structure timeStamp
        long secondsPastEpoch 0
        int nanoSeconds 0
        int userTag 0
    structure alarm
        int severity 0
        int status 0
        string message 
    string[] label [...]
    ... // value field </pre>

<h2>Relational Database </h2>

<h3>SQLite3 Schema </h3>
Currently, SQLite3 is the only database supported by MASAR service. Its
original schema is inherited from IRMIS, and now is as below: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/masar-sqlite-eer.png" width="480" height="360"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR SQLite3 Schema</td>
    </tr>
  </tbody>
</table>

<h3>IRMIS Schema </h3>
When IRMIS support is implemented the DSL layer will make switching between the
different relational database almost seamless. However the database schemas
must be similar. For example to minimize the effort when switching from SQLite
to IRMIS, the IRMIS schema will be similar to the SQLite3 schema. 

<table>
  <tbody>
    <tr>
      <td><img src="masar/masar-eer.png" width="480" height="480"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR IRMIS Schema</td>
    </tr>
  </tbody>
</table>

<h3>Create Database </h3>

<p>This section is for <b>SQLite3</b> database only. The files for SQL are
located in directory:</p>
<pre>masarService/python/pymasar/db</pre>

<p>The generated data base will be stored in a place You specify. You also need
to create a directory that holds text files that each has a list of V3 channel
names. There is an example directory located in:</p>
<pre>masarService/example</pre>

<p>It has a subdictory pvs that has example channel list files. For example
pvs/example.txt contains:</p>
<pre>masarExample0000
masarExample0001
 ...
masarExample0999</pre>

<p>The SQL file is masars-qlite.sql. File createSqliteDb.py is the Python
script that create an SQLite3 database. . An example of how tp create a MASAR
datatbase is:</p>
<pre>$cd masarService/example
$python ../python/pymasar/db/createSqliteDb.py</pre>
This creates a new MASAR database called "masar.db" that is located in the
example directory. If there is an error like: 
<pre>create a new SQLite db.
Traceback (most recent call last):
  File "../python/pymasar/db/createSqliteDb.py", line 109, in &lt;              module&gt;
    createSqliteDb()
  File "../python/pymasar/db/createSqliteDb.py", line 59, in createSqliteDb
    from pymasar.db.masarsqlite import SQL
ImportError: No module named pymasar.db.masarsqlite</pre>
Check the PYTHONPATH setting. 

<p>If the "masar.db" exists already, you will be asked </p>
<pre>SQLite database masar.db exists already.
Do you want to overwrite it? Yes, [N]o (default = No):</pre>

<p>Choose Yes to overwrite current masar.db file, otherwise No. </p>

<p>If you want give database file a name instead of using default "masar.db",
you can do </p>
<pre>$ python ../python/pymasar/db/createSqliteDb.py -db test.db
SQLite3 database:  test.db
create a new SQLite db: test.db.</pre>

<p>After created MASAR database, an environment variable needs to be set as
(BASH environment) </p>
<pre>export MASAR_SQLITE_DB=~/V4/masarService/example/masar.db</pre>
If the database is named differently, use right database file name. 

<h3>Database initialization </h3>

<p>This section is also only for an SQLite3database and again the files
described below are located in:</p>
<pre>masarService/python/pymasar/db</pre>

<p>After creating the SQLite3 database, it has to be initialized, and some
information about service configuration have to be configured in advance before
allowing MASAR server uses it. </p>

<p>The database configuration, which is an administrative work, is separated
from MASR service, and could be done through calling PYMASAR API. A Python
Script, setmasardb.py initialize the database. This is also located in:</p>
<pre>masarService/python/pymasar/db</pre>

<p>The following is an example showing how to configure MASAR database. </p>

<p>Site-specific information is configured in settings.p, which has format as
below: </p>
<pre># pv group name: [pv list file, description]
pvgroups= {
    'test':         ['example.txt', 'server test'],
    'wftest':       ['exampleWf.txt', 'server test with waveform'],
    'bigwftest':    ['exampleBigWf.txt', 'server test with big waveform']
}

# config name: [config desc, system]
configs= {
    'sr_test':      ['test pv config', 'test'],
    'wf_test':      ['waveform test pv config', 'test'],
    'bwf_test':     ['big waveform test pv config', 'test']
}

# config name: [pvgroup,]
pvg2config= {
    'sr_test':   ['test'],
    'wf_test':   ['wftest'],
    'bwf_test':  ['wftest', 'bigwftest']
}</pre>

<p>There are 3 variables defined in settings.py </p>
<ol>
  <li><b>pvgroups</b>. A Python dictionary with group name as key. Each pv
    group is a collection of V3 channel names. The value is a the name of a
    file that holds a list of channel names and configuration description. The
    pv group name has to be global unique.</li>
  <li><b>configs</b>. It is a Python dictionary with configure name as key.
    Each config has a Python list as its value, which includes configure
    description, and which system it belongs to. The config name has to be
    global unique. </li>
  <li><b>pvg2config</b>. It is a Python dictionary with configure name as key.
    The value of each key is a collection list of pv group name. </li>
</ol>

<p>After the settings.py is configured, setmasardb.py creaates the database.
Assume the database is called masar.db, and is located in
masarService/example</p>
<pre>$ python ../python/pymasar/db/setmasardb.py</pre>
it requests the absolute path of pv list file directory. 
<pre>Please give absolute ROOT PATH of your pv list files 
[default: /home/xxxx/V4/masarService/python/pymasar/db/pvs]:</pre>
here give the pv list directory PATH, for example
/home/xxxx/V4/masarService/pvs: 
<pre><span style="color: rgb(204, 0, 0);">/home/xxxx/V4/masarService/example/pvs</span>
Use new ROOT: /home/xxxx/V4/masarService/example/pvs</pre>

<p>If the path is wrong, it raises an exception. After loading pv names into
database, it tries to save configuration. If a configuration exists already, it
reports for example, and ignores that configuration: </p>
<pre>configuration name (bwf_test) exists already.
configuration name (sr_test) exists already.
configuration name (wf_test) exists already.</pre>

<p>After finished the database configuration, it is ready to launch MASAR
server. </p>

<h2>Installation </h2>

<p>At current stage, all EPICS V4 packages are available as source code, which
can be checked out from by sourceforge mercurial repository. To compile all V4
module Python 2.7 and EPICS V3 development packages must be installed. EPICS V3
base is available as a Debian package from <a
href="http://epics.nsls2.bnl.gov/debian/">NSLS-II Debian package server</a>.
Here we assume EPICS V3 base is installed under <span
style="color: rgb(0, 153, 0);">/usr/lib/epics</span>. </p>
A step-by-step installation is introduced here, and the example is to show how
to install whole packages on Ubuntu 11.04 x86_64 system. You should be able to
install all modules on other systems following the same procedure. You can
check your system architecture using for example on linux: 
<pre>$ uname -m<br>x86_64<br></pre>

<h3>Preparation</h3>
Here we assume you want to install all modules under ~/V4<br>

<pre>$ cd
$ mkdir V4
$ cd V4
$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/pvDataCPP
$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/pvAccessCPP
$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/pvIOCCPP
$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/alphaCPP

$ hg clone http://epics-pvdata.hg.sourceforge.net/hgroot/epics-pvdata/masarService</pre>
NOTE: Make sure you have following line in each module in configure/RELEASE.
Suggest to put it as the last line if it is not. 
<pre>-include $(TOP)/configure/RELEASE.local</pre>

<h3>Install pvDataCPP </h3>
<pre>$ cd pvDataCPP</pre>
Add the following to configure/RELEASE.local 
<pre>EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3>Install pvAccessCPP</h3>
<pre>$ cd ../pvAccessCPP&lt; </pre>
Add the following to configure/RELEASE.local 
<pre>PVDATA=~/V4/pvDataCPP
EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3>Install pvIOCCPP </h3>
<pre>$ cd ../pvIOCCPP</pre>
Add the following to configure/RELEASE.local 
<pre>PVDATA=~/V4/pvDataCPP
PVACCESS=~/V4/pvAccessCPP
EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3>Install normativeTypes</h3>
<pre>$ cd ../alphaCPP/normativeTypes/</pre>
Add the following to configure/RELEASE.local 
<pre>PVDATA=~/V4/pvDataCPP
PVACCESS=~/V4/pvAccessCPP
EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>

<h3>Install masarService </h3>
<pre>$ cd ../../masarService/cpp</pre>
Add the following to configure/RELEASE.local 
<pre>PYTHON=python2.7
PYTHON_BASE=/usr
$(PYTHON)_DIR = $(PYTHON_BASE)/lib/$(PYTHON)/config 
NUMPY_CORE=${PYTHON_BASE}/lib/${PYTHON}/site-packages/numpy/core

PVDATA=~/V4/pvDataCPP
PVACCESS=~/V4/pvAccessCPP
PVIOC=~/V4/pvIOCCPP
NTTYPE=~/V4/alphaCPP/normativeTypes

EPICS_BASE=/usr/lib/epics</pre>
Then 
<pre>$ make</pre>
The installation procedure is complete if the above is successful. 

<h2>Run MASAR Server </h2>

<p>After installing all required modules and configuring the sql database the
last step is to prepare and check the Python environment. </p>

<h3>Python/C module<br>
</h3>
Python looks for the shared library to load modules. You need to create some
symbol links if it is not done yet. 
<pre>$ cd
$ cd ~/V4/masarService/cpp/src/python
$ python generateSOLinks.py</pre>
If you did not set EPICS_HOST_ARCH environment, you will be promoted as below: 
<pre>EPICS_HOST_ARCH is not setted.<br>Please specify EPICS_HOST_ARCH:</pre>

<p>You can specify your host architecture here, for example, linux-x86_64 if
you are using a 64-bit linux machine. An error will occur as below if the
EPICS_HOST_ARCH is wrong: </p>
<pre>EPICS_HOST_ARCH is not setted.
Please specify EPICS_HOST_ARCH:linux-x86
Traceback (most recent call last):
  File "generateSOLinks.py", line 32, in &lt;module&gt;
    fileList = os.listdir(libDir)
OSError: [Errno 2] No such file or directory: '../../lib/linux-x86'</pre>

<p>An alternative solution is to set the environment before running
generateSOLinks.py, for example:<br>
</p>
<pre>$ export EPICS_HOST_ARCH=linux-x86_64</pre>

<h3>PYTHONPATH</h3>
The PYTHONPATH must be defined as follows. It could be defined in .bash_profile 
<pre>$ export PYTHONPATH=~/V4/masarService/python
export PYTHONPATH=${PYTHONPATH}:~/V4/masarService/cpp/src/python
export PYTHONPATH=${PYTHONPATH}:~/V4/masarService/python/client
export PYTHONPATH=${PYTHONPATH}:~/V4/masarService/python/server</pre>

<h3>MASAR SQLite database</h3>
You also need to set the MASAR_SQLITE_DB to allow PYMASAR module to find the
SQLite3 database. Here is an example. It can also be put in .bash_profile
<pre>export MASAR_SQLITE_DB=~/V4/masarService/example/masar.db</pre>

<p>Now it is ready to go. </p>

<h3>Launch MASAR service</h3>

<p>The following packages are needed to run MASAR server.</p>
<ul>
  <li>Python 2.7 or above</li>
  <li>SQLite3 3.7 or above</li>
</ul>
<pre>$ cd ~/V4/masarService/cpp
$ ./bin/linux-x86_64/masarServiceRun</pre>
You will see the following output 
<pre>ChannelBaseProvider::ChannelBaseProvider pvService
VERSION : CA Server v0.9.0
PROVIDER_NAMES : pvService
BEACON_ADDR_LIST : 
AUTO_BEACON_ADDR_LIST : 1
BEACON_PERIOD : 15
BROADCAST_PORT : 5067
SERVER_PORT : 5066
RCV_BUFFER_SIZE : 16384
IGNORE_ADDR_LIST: 
STATE : INITIALIZED
masarService
Type exit to stop: </pre>

<p>You have started the server now successfully. However, if you see this
output: </p>
<pre>ChannelBaseProvider::ChannelBaseProvider pvService
VERSION : CA Server v0.9.0
PROVIDER_NAMES : pvService
BEACON_ADDR_LIST : 
AUTO_BEACON_ADDR_LIST : 1
BEACON_PERIOD : 15
BROADCAST_PORT : 5067
SERVER_PORT : 5066
RCV_BUFFER_SIZE : 16384
IGNORE_ADDR_LIST: 
STATE : INITIALIZED
<span style="color: rgb(204, 0, 0);">DSL_RDB::init dslPY does not exist or is not a python module</span>
masarService
Type exit to stop: </pre>

<p>which means either the PYTHONPATH is not set correctly, or MASAR can not
find. Check the MASAR_SQLITE_DB and PYTHONPATH. </p>

<h3>Launch MASAR with other name</h3>
Above description explains how to launch MASAR service with default name. Since
a client uses the name to communicate with server, the server name can be given
when launching it as below, for example to name the RPC channel as
"MASARSERVICE:TEST:EXAMPLE": 
<pre>$ cd ~/V4/masarService/cpp
$ ./bin/linux-x86_64/masarServiceRun MASARSERVICE:TEST:EXAMPLE</pre>
it will shows 
<pre>ChannelBaseProvider::ChannelBaseProvider pvService
VERSION : CA Server v0.9.0
PROVIDER_NAMES : pvService
BEACON_ADDR_LIST : 
AUTO_BEACON_ADDR_LIST : 1
BEACON_PERIOD : 15
BROADCAST_PORT : 5067
SERVER_PORT : 5066
RCV_BUFFER_SIZE : 16384
IGNORE_ADDR_LIST: 
STATE : INITIALIZED
<span style="color: rgb(204, 0, 0);">MASARSERVICE:TEST:EXAMPLE</span>
Type exit to stop: </pre>

<h3>Stop MASAR service</h3>

<p>To stop server, type "exit" and you will get the following message: </p>
<pre>Type exit to stop: 
exit
ServiceChannelRPC::~ServiceChannelRPC()
MasarService::destroy()
PVServiceProvider::unregister
PVServiceProvider::~PVServiceProvider
PVServiceProvider::destroy
void PVTop::destroy()
PVTop::~PVTop()
MasarService::~MasarService()
close SQLite3 connection.
ChannelBaseProvider::~ChannelBaseProvider
timerNode:  totalConstruct 1 totalDestruct 1
blockingUDPTransport:  totalConstruct 1 totalDestruct 1
timer:  totalConstruct 1 totalDestruct 1
LinkedList:  totalConstruct 4 totalDestruct 4
LinkedListNode:  totalConstruct 6 totalDestruct 6
event:  totalConstruct 5 totalDestruct 5</pre>

<h2>MASAR Client </h2>
There are 2 ways to use MASAR client, using either the Python API or the
default PyQt4 GUI. 

<h3>Python API </h3>
The client API is defined in masarClient.py. 

<p>client.<b>retrieveSystemList</b>()<br>
Retrieve all system and return as a list, or False if failed. </p>

<p>client.<b>retrieveServiceConfigs</b>(params)<br>
Retrieve all configuration information. The params is as a dictionary which can
have any combination of the following keys:<br>
key names: </p>
<pre>["servicename", "configname", "system"]</pre>
It returns all configurations that satisfies the search constrains, or False if
failed:<br>

<pre>config id []
config name []
config description []
version []</pre>
The version is a reserved function for future. 

<p>client.<b>retrieveServiceEvents</b>(params)<br>
Retrieve all events including event id, user comment, user name, and UTC
time.<br>
It retrieves all events without any V3 IOC data. The params is as a dictionary
which can have any combination of the following keys:<br>
key names: </p>
<pre>["configid", "start", "end", "comment", "user"]</pre>
The value of each key needs to be a string. The "start" and "end" is for time
range in UTC format.<br>
It returns all event list that satisfies the search constrains, or False if
failed:<br>

<pre>event id []
event description []
UTC date time  []
author/user []</pre>

<p>client.<b>retrieveSnapshot</b>(params)<br>
Retrieve a particular snapshot, which is flagged to be an approved snapshot,
with all pv data.<br>
The params is as a dictionary which can have any combination of the following
keys:<br>
key names: </p>
<pre>["eventid", "start", "end", "comment"]</pre>
The value of each key needs to be a string. The "start" and "end" is for time
range in UTC format.<br>
It returns snapshot that satisfies the search constrains, or False if failed: 
<pre>pv name []
string value []
double value []
long value []
dbr_type []
isConnected []
secondsPastEpoch []
nanoSeconds []
alarmSeverity []
alarmStatus []
is_array []
array_value [[]]</pre>
For a scalar pv, its value is carried in string, double and long. For a
waveform/array, its value is carried in array_value. Client needs to check the
pv is an array by checking is_array, and check its data type by checking
dbr_type. 
<pre>        # DBR_TYPE definition defined in db_access.h
        #define DBF_STRING      0
        #define DBF_INT         1
        #define DBF_SHORT       1
        #define DBF_FLOAT       2
        #define DBF_ENUM        3
        #define DBF_CHAR        4
        #define DBF_LONG        5
        #define DBF_DOUBLE      6
        #define DBF_NO_ACCESS   7

        # type mapping in python
        epicsLong   =   [1, 4, 5]
        epicsString =   [0, 3]
        epicsDouble =   [2, 6]
        epicsNoAccess = [7]</pre>

<p>client.<b>saveSnapshot</b>(params)<br>
Save a snapshot into database, and does not flag it to be approved.<br>
The params is as a dictionary which can have any combination of the following
keys:<br>
key names: </p>
<pre>["servicename","configname","comment"]</pre>
The value of each key needs to be a string. It saves all data into database,
and returns the same data back to the client, which means the return data is
same the retrieveSnapshot function. 

<p>client.<b>updateSnapshotEvent</b>(params)<br>
Flag a particular snapshot to be approved..<br>
The params is as a dictionary which can have any combination of the following
keys:<br>
key names: </p>
<pre>["eventid", "user", "desc"]</pre>
The value of each key needs to be a string. It returns True if succeeded,
otherwise, false. 

<p>client.<b>getLiveMachine</b>(params)<br>
Get live data with given pv list. Following the same params format, it uses pv
name as both key and value. It returns </p>
<pre>pv name []
string value []
double value []
long value []
dbr_type []
isConnected []
is_array []
array_value [[]]</pre>
Same as retrieveSnapshot function, for a scalar pv, its value is carried in
string, double and long. For a waveform/array, its value is carried in
array_value. Client needs to check the pv is an array by checking is_array, and
check its data type by checking dbr_type. 

<h3>Default GUI </h3>
A default GUI is developed using PyQt4. A start script can be found under
masarService/cpp. Here assume the MASAR server has been started with the name
"MASARSERVICE:TEST:EXAMPLE". Client GUI can be launched as below: 
<pre>$ python masarClient MASARSERVICE:TEST:EXAMPLE</pre>
A GUI will be launched as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MasarViewer.png" width="480" height="380"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Main Page</td>
    </tr>
  </tbody>
</table>
If it can not connect to the MASAR server, a warning dialog will pop up as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MasarNoService.png" width="420" height="166"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR No Service Dialog</td>
    </tr>
  </tbody>
</table>
If server is connected successfully, all systems are available as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARSystem.png" width="480" height="375"></td>
    </tr>
    <tr>
      <td style="text-align:center">System selection</td>
    </tr>
  </tbody>
</table>
After selected desired system, click on "Fetch Config(s)" button, all
configurations for selected system are retrieved from database and shown in
configure table as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARConfig.png" width="480" height="375"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Configuration List</td>
    </tr>
  </tbody>
</table>
To select a configuration, click on a row on the configure table, or hold Ctrl
key if using for example Linux, or Command key for MAC OS-X + click on
different row to select multiple configurations. User is able also to filter
the event description, author/user name, and time range.<br>
After selected configure(s), click on "Fetch Event(s)" button to retrieve event
list. 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASAREvent.png" width="480" height="375"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Event List</td>
    </tr>
  </tbody>
</table>
If the event table shows nothing above, it means there is no qualified event
snapshot for that configuration with given constrains.<br>
<br>
To take a machine snapshot, select one configuration, then click on "Preview
Button". A machine preview will be taken, and get a result like: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARPreview.png" width="480" height="375"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Snapshot Preview</td>
    </tr>
  </tbody>
</table>
If there is nothing showing up, it means probably no pv can be connected.<br>
After verifying the preview, click "Save Current Preview" button to flag this
preview approved. A dialog will pop up to confirm as below: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARSavePreviewDlg.png" width="500"
      height="243"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Approval Dialog</td>
    </tr>
  </tbody>
</table>
By clicking "Yes", a comment dialog will pop up to ask for Author for who does
this, and comment as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARPreviewComment.png" width="496"
      height="316"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Snapshot Comment</td>
    </tr>
  </tbody>
</table>
Click "OK" after done. A success message dialog will show up as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARPreviewDone.png" width="382" height="243"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Snapshot Approved</td>
    </tr>
  </tbody>
</table>
After saved it, it should appear in event table as follow if clicking "Fetch
Snapshot(s)" and make sure correct time range if "Use time range" is checked. 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARSnapshot.png" width="480" height="387"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Snapshot</td>
    </tr>
  </tbody>
</table>
It can be selected, and appear on right side window by clicking "Fetch
Snapshot".<br>
<br>
To compare a snapshot with live machine, just click "Compare Live Machine"
button, and all live data will display on the same window for all available pv
data as below: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARCompare.png" width="480" height="387"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Compare a Snapshot With Live
      Machine</td>
    </tr>
  </tbody>
</table>
The difference between snapshot and live machine will be calculated for a
scalar pv. For an array pv, a pop-up dialog will be displayed by double
clicking on either "Saved Value" cell or "Live value" cell as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARArrayCompare.png" width="188" height="302"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Compare Array PV</td>
    </tr>
  </tbody>
</table>
It will display how many points in saved data, and how many in live data, and
detailed data value.<br>
To restore the machine, select one snapshot, and click "Restore Machine"
button. A dialog will pop up to show either succeed to restore machine or fail
as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARRestore.png" width="500" height="243"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Restore Confirmation</td>
    </tr>
  </tbody>
</table>
The restore result can be confirmed by comparing the live machine again as: 

<table>
  <tbody>
    <tr>
      <td><img src="masar/MASARCompareAfterRestore.png" width="714"
        height="529"></td>
    </tr>
    <tr>
      <td style="text-align:center">MASAR Compare Restore Result</td>
    </tr>
  </tbody>
</table>
<hr>
<address>
  Guobao Shen, BNL 
</address>
<!-- hhmts start -->
Last modified: Fri Mar 9 22:14:42 EST 2012<!-- hhmts end -->
<hr>
</body>
</html>
